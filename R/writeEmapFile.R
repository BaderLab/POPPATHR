#' Writes enrichment file for use in Cytoscape EnrichmentMap
#'
#' @param resultsFile (list) file paths to results.txt for each population comparison
#' (generated by setupGSEArun.R).
#' @param enrichFDR (numeric) FDR cutoff to select validated selection-enriched
#' pathways (default=0.05).
#' @param outFile (char) name of output file.
#' @export
writeEmapFile <- function(resultsFile, enrichFDR=0.05, outFile) {
    # Read in GSEA results files formatted for EnrichmentMap
    cat(sprintf("* Reading in GSEA results file %s\n", resultsFile))
    resNames <- lapply(strsplit(resultsFile, "\\/"), "[", 2)
    resFiles <- lapply(resultsFile, function(x) read.delim(x, h=TRUE, as.is=TRUE))

    # Prepare data to combine
    for (i in seq_along(resFiles)) {
        resFiles[[i]] <- resFiles[[i]][,c("pathway", "pathway", "pval", "padj", "NES")]
        colnames(resFiles[[i]]) <- c("Geneset", "Description", "NominalP", "FDR", "NES")
        colnames(resFiles[[i]])[3:5] <- paste(colnames(resFiles[[i]][, c(3:5)]), resNames[i], sep="_")
    }

    # Combine results from both population comparisons
    resComb <- reduce(resFiles, left_join, by=c("Geneset", "Description"))

    # Select for enriched pathways
    resCombEnrich <- filter(resComb, get(paste0("FDR_", resNames[1])) <= enrichFDR)
    if (length(resFiles) > 1) { # filter by second population analysis if run
        resCombEnrich <- filter(resCombEnrich, get(paste0("FDR_", resNames[2])) <= enrichFDR)
    }

    # Remove gene set annotation details from Description column
    # Needed for AutoAnnotate app to properly annotate aggregated gene sets
    resCombEnrich$Description <- gsub("\\%.*", "", resCombEnrich$Description)

    # Write out file for EnrichmentMap input
    emOut <- resCombEnrich[,c(1:4)]
    cat(sprintf("* Writing out formatted GSEA file to %s.\n", outFile))
    write.table(emOut, outFile, col=TRUE, row=FALSE, quote=FALSE, sep="\t")
}
