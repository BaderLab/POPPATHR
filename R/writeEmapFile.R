#' Write enrichments file for use in Cytoscape EnrichmentMap
#'
#' @param resEmF (list) file paths to results_forEM.txt for each population comparison
#' 		(generated by setupGSEA_run.R).
#' @param enrichNES (integer) NES cutoff to select validated selection-enriched
#'		pathways (default=3)
#' @param outF (char) name of output file.

#' @return none. Output file write into directory of first population comparison.
#'    E.g., CEU_YRI directory
#' @export
#'

writeEmapFile <- function(resEmF, enrichNES=3, outF) {
  # Read in GSEA results files formatted for EnrichmentMap
  EMfiles <- lapply(resEmF, function(x) read.delim(x, h=TRUE, as.is=TRUE))
  for (i in seq_along(EMfiles)) {
    colnames(EMfiles[[i]])[3:5] <- paste(colnames(EMfiles[[i]][, c(3:5)]), i, sep="_")
  }
  EMcomb <- join_all(EMfiles, by=c("Geneset", "Description"))
  # Select for enriched pathways
  EMcomb_enrich <- filter(EMcomb, NES_1 >= enrichNES & FDR_1 <= 0.05)
  if (length(EMfiles) > 1) { # filter by second population analysis if run
    EMcomb_enrich <- filter(EMcomb, NES_2 >= NEScut & FDR_2 <= 0.05)
  }
  # Remove gene set annotation details from Description column
  ## Needed for AutoAnnotate app to properly annotate aggregated gene sets
  EMcomb_enrich$Description <- gsub("\\%.*", "", EMcomb_enrich$Description)
  # Write out file for EnrichmentMap input
  EMout <- EMcomb_enrich[,c(1:4)]
  write.table(EMout, outF, col=TRUE, row=FALSE, quote=FALSE, sep="\t")
}
